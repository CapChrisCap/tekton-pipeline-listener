  
version: 2
jobs:
  build:
    docker:
      - image: alpine/helm:3.2.4
    steps:
      - checkout
      - run:
          name: helm-github-pages
          environment:
            - GITHUB_PAGES_REPO: capchriscap/helm-charts
            - GITHUB_PAGES_BRANCH: master
            - HELM_CHART: tekton-pipeline-listener
            - HELM_CHART_FOLDER: helm
          command:
            - REPO_DIR="$PWD"
            - git clone https://github.com/$GITHUB_PAGES_REPO /helm-charts
            - echo '>> Building chart...'
            - echo ">>> helm lint $HELM_CHART_FOLDER"
            - helm lint "$HELM_CHART_FOLDER"
            - echo ">>> helm package -d /helm-charts/$HELM_CHART $HELM_CHART_FOLDER"
            - helm package -d /helm-charts/$HELM_CHART $HELM_CHART_FOLDER
            - echo '>>> helm repo index'
            - cd /helm-charts
            - helm repo index .
            - git config user.email "$CIRCLE_USERNAME@users.noreply.github.com"
            - git config user.name CircleCI
            - git add .
            - git status
            - git commit -m "Published by CircleCI $CIRCLE_BUILD_URL"
            - git push origin "$GITHUB_PAGES_BRANCH"
